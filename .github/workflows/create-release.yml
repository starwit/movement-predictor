name: Create release

on:
  workflow_dispatch:
    inputs:
      versionChoice:
        type: choice
        required: true
        description: Version Change
        options:
        - patch
        - minor
        - major

permissions:
  contents: write

jobs:
  checkout:
    name: checkout
    runs-on: [self-hosted, linux, X64]

    steps:
      - name: checkout project definition
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'

  # test python compilation
  build:
    name: "Build and run docker image"
    needs: checkout
    runs-on: [self-hosted, linux, X64]

    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: build docker
      run: |
        docker build -t docker.internal.starwit-infra.de/movement-predictor:tmp .

  cleanup:
    name: "Clean docker"
    needs: build 
    runs-on: [self-hosted, linux, X64]
    if: always()

    steps:
      - name: docker cleanup
        run: |
          docker buildx prune -af
          docker rmi docker.internal.starwit-infra.de/movement-predictor:tmp

  createversion:
    name: "Create new project version"
    needs: build
    runs-on: [self-hosted, linux, X64]
    container:
      image: acidrain/python-poetry:3.11-slim-1.8.5

    steps:
    - name: create new version in pyproject.toml
      run: |
        poetry version $VERSION
      env:
        VERSION: ${{ inputs.versionChoice }}

  pushversion:
    name: checkin pyproject.toml and create github release
    needs: createversion
    runs-on: [self-hosted, linux, X64]

    steps:
    - name: Install GH CLI
      uses: dev-hanz-ops/install-gh-cli-action@v0.2.0

    - name: commit new version
      run: |
        git config --global user.email "code@starwit.de"
        git config --global user.name "Starwit"
        git remote set-url --push origin https://Starwit:$GITHUB_TOKEN@github.com/starwit/movement-predictor.git
        git add .
        modifications=$(git status | grep "modified" || true)
        if [ ! -z "$modifications" ]
        then
          echo "modifications found: $modifications"
          git commit -m "modified project version" ./pyproject.toml
          git push
        fi 
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create github release
      run: | 
        APP_VERSION=$(cat pyproject.toml | grep "version" | cut -d'=' -f2 | xargs echo -n)
        gh release create $APP_VERSION -F README.md
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VERSION: ${{ inputs.versionChoice }}
  

